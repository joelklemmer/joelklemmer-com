# One-time or on-demand: generate Linux visual baselines so CI visual job passes.
# CI compares against apps/web-e2e/__screenshots__/linux/; this workflow creates/updates those files.
# Run from Actions tab → "Update Linux visual baselines" → "Run workflow" (branch = your branch).
# Creates a PR with baseline changes; no direct push to main (works with protected branches).
# Determinism: ubuntu-22.04 pinned (not ubuntu-latest); PLAYWRIGHT_BROWSERS_PATH=0 for hermetic install.
name: Update Linux visual baselines

on:
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: update-baselines-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true
  NX_CLOUD: 'false'
  RATE_LIMIT_MODE: off
  PORT: '3000'

jobs:
  update-baselines:
    name: update-linux-baselines
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.2

      - name: Get pnpm store path
        id: pnpm-store
        run: echo "path=$(pnpm store path)" >> "$GITHUB_OUTPUT"

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-store.outputs.path }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Cache Nx
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: ${{ runner.os }}-nx-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-nx-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        env:
          PLAYWRIGHT_BROWSERS_PATH: '0'
        run: pnpm exec playwright install --with-deps chromium

      - name: Generate Linux visual baselines
        env:
          PLAYWRIGHT_BROWSERS_PATH: '0'
          __E2E__: 'true'
          RATE_LIMIT_MODE: off
        run: pnpm nx run web:visual -- --update-snapshots --verbose

      - name: Create PR with Linux baselines
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ci/update-linux-visual-baselines
          add-paths: apps/web-e2e/__screenshots__/linux/
          commit-message: "chore(ci): update Linux visual baselines"
          title: "chore(ci): update Linux visual baselines"
          body: "Automated baseline refresh from ubuntu-22.04 CI."
          delete-branch: true
