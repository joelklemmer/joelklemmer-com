# Verify chain

The verify chain is the ordered sequence of checks that must pass before the platform is considered valid. It is implemented as the Nx target `web:verify` in `apps/web/project.json` (executor: `nx:run-commands`, `parallel: false`). The pipeline stops on first failure. No step is optional.

## Command

- **Local full chain:** `nx run web:verify`
- **Install + verify (CI parity):** `pnpm run ci:verify` → `pnpm install --frozen-lockfile` then `nx run web:verify --verbose`

## Targets in execution order

The order below matches `apps/web/project.json` → `targets.verify.options.commands`. All validator targets run: `npx tsx --tsconfig tsconfig.base.json tools/<script>.ts`. Path aliases from `tsconfig.base.json` apply.

| #   | Target                               | What runs                                                                    | Failure meaning                                                                                                                        |
| --- | ------------------------------------ | ---------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | **(clean)**                          | Remove `apps/web/.next` if present (inline Node script)                      | N/A (best-effort rm)                                                                                                                   |
| 2   | **format:check**                     | `nx format:check --all`                                                      | One or more files not formatted; Prettier/Nx format fails. Fix with `nx format:write --all`.                                           |
| 3   | **audit**                            | `pnpm audit --audit-level=critical`                                          | At least one critical vulnerability in dependencies. Resolve or audit suppress.                                                        |
| 4   | **lint**                             | `nx run web:lint`                                                            | ESLint reports errors (or warnings if configured to fail). Fix in `apps/web` (and config in `eslint.config.mjs`).                      |
| 5   | **security-validate**                | `tools/validate-security-txt.ts`                                             | `.well-known/security.txt` missing, or Contact/Expires missing, or Expires not in the future. Script exits non-zero.                   |
| 6   | **cookie-compliance-validate**       | `tools/validate-cookie-compliance.ts`                                        | Cookies page missing, manifest mismatch, preferences UI missing a11y, or non-gated tracker code. Exits 1.                              |
| 7   | **content-validate**                 | `tools/validate-content.ts`                                                  | MDX frontmatter/slugs invalid, proofRefs/claims/artifacts/media inconsistent. Throws "Content validation failed".                      |
| 8   | **docs-integrity-validate**          | `tools/validate-docs-integrity.ts`                                           | Project missing README, broken doc link, reference to non-existent file, or README layout path missing. Exits 1.                       |
| 9   | **governance-validate**              | `tools/validate-governance.ts`                                               | Governance doc or config checks fail. Throws "Governance validation failed".                                                           |
| 10  | **i18n-validate**                    | `tools/validate-i18n.ts`                                                     | Message keys, structure, or required namespaces missing for any locale. Throws "i18n validation failed".                               |
| 11  | **pgf-validate**                     | `tools/validate-pgf.ts`                                                      | Duplicate H1/lede/CTA (default locale), or claims registry duplicate labelKey/summaryKey, or CTA not on allowlist. Throws with report. |
| 12  | **intelligence-validate**            | `tools/validate-intelligence.ts`                                             | Entity graph or semantic index invalid or orphans. Exits 1.                                                                            |
| 13  | **briefing-contracts-validate**      | `tools/validate-briefing-contracts.ts`                                       | Briefing contracts violated. Exits 1.                                                                                                  |
| 14  | **authority-signals-validate**       | `tools/validate-authority-signals.ts`                                        | Entity→signals mapping, entropy, or topology errors; severe collapse. Exits 1.                                                         |
| 15  | **experience-intelligence-validate** | `tools/validate-experience-intelligence.ts`                                  | Experience/intelligence surface consistency failed. Exits 1.                                                                           |
| 16  | **frameworks-validate**              | `tools/validate-frameworks.ts`                                               | Framework content or structure invalid. Exits 1.                                                                                       |
| 17  | **aec-validate**                     | `tools/validate-aec.ts`                                                      | AEC (brief) panel or intent inconsistent. Exits 1.                                                                                     |
| 18  | **orchestration-validate**           | `tools/validate-orchestration.ts`                                            | Authority orchestration consistency failed. Exits 1.                                                                                   |
| 19  | **content-os-validate**              | `tools/validate-content-os.ts`                                               | Page intent, contentOS keys, meta/CTA, or placeholder copy in default locale. Throws with report.                                      |
| 20  | **home-validate**                    | `tools/validate-home.ts`                                                     | Home: placeholder in home.json, multiple H1, missing required links, or heading outline/PGF violation. Throws with report.             |
| 21  | **sitemap-validate**                 | `tools/validate-sitemap.ts`                                                  | Sitemap entry count, duplicate URLs, or missing dynamic public record/case study URLs. Throws "Sitemap validation failed".             |
| 22  | **image-sitemap-validate**           | `tools/validate-image-sitemap.ts`                                            | Image sitemap: count over limit, required fields missing, or files absent. Throws.                                                     |
| 23  | **media-manifest-validate**          | `tools/validate-media-manifest.ts`                                           | Manifest completeness (alt, descriptor, prefix) or sitemap eligibility. Throws.                                                        |
| 24  | **media-derivatives-validate**       | `tools/validate-media-derivatives.ts`                                        | Media derivatives missing or inconsistent. Throws.                                                                                     |
| 25  | **media-authority-validate**         | `tools/validate-media-authority.ts`                                          | Tier C sitemap eligibility or authority rules violated. Throws.                                                                        |
| 26  | **media-governance-validate**        | `tools/validate-media-governance.ts`                                         | Media governance rules failed. Throws.                                                                                                 |
| 27  | **visual-contract-validate**         | `tools/validate-visual-contract.ts`                                          | Design tokens or layout contract violated. Throws.                                                                                     |
| 28  | **lighthouse-config-validate**       | `tools/validate-lighthouse-configs.ts`                                       | Assertions in lighthouserc.serverless.cjs differ from lighthouserc.cjs. Exits 1.                                                       |
| 29  | **seo-validate**                     | `tools/validate-seo.ts`                                                      | Canonical/hreflang, JSON-LD, sameAs, or meta invalid; placeholder env when required. Throws "SEO validation failed".                   |
| 30  | **tokens-validate**                  | `tools/validate-tokens.ts`                                                   | Token file missing or required tokens absent. Throws.                                                                                  |
| 31  | **token-drift-validate**             | `tools/validate-token-drift.ts`                                              | Literal colors or non-token Tailwind in governed components. Throws.                                                                   |
| 32  | **authority-program-validate**       | `tools/validate-authority-program.ts`                                        | Program doc missing/invalid or required SEO outputs (sitemap, image sitemap) failed. Throws.                                           |
| 33  | **authority-constitution-validate**  | `tools/validate-authority-constitution.ts`                                   | Authority constitution docs or rules failed. Exits 1.                                                                                  |
| 34  | **agent-overlay-validate**           | `tools/validate-agent-overlay.ts`                                            | Agent overlay JSON schema, file paths, or Nx targets invalid. Exits 1.                                                                 |
| 35  | **telemetry-scoring-validate**       | `tools/validate-telemetry-scoring.ts`                                        | Telemetry scoring rules failed. Exits non-zero or throws.                                                                              |
| 36  | **docs:arch:check**                  | `nx run docs:arch:check`                                                     | Architecture outputs missing or stale (run `nx run docs:arch` and commit). Exits 1.                                                    |
| 37  | **test**                             | Inline: `node -e "console.log('No web tests configured')"`                   | Never fails.                                                                                                                           |
| 38  | **build**                            | `nx run web:build`                                                           | Next.js build fails (e.g. type error, missing env in production).                                                                      |
| 39  | **restore-generated-typings**        | `git checkout -- apps/web/next-env.d.ts`                                     | Uncommitted changes to that file remain; repo not clean.                                                                               |
| 40  | **a11y**                             | `npx cross-env SKIP_A11Y_BUILD=1 nx run web:a11y`                            | Playwright + axe reports accessibility violations or script fails.                                                                     |
| 41  | **rate-limit-verify**                | `tools/test-rate-limit.ts` (RATE_LIMIT_MODE=always, SKIP_RATE_LIMIT_BUILD=1) | 429 triggers, 429 HTML title/lang, dir=rtl for /he/; rate limiter and shell correctness. Exits 1.                                      |

## CI jobs

CI (`.github/workflows/ci.yml`) does not run the single `web:verify` target. It splits work into jobs:

| Job             | Runs                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Failure meaning                                                                                                                                |
| --------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| **verify-fast** | Checkout, Node 20.19.0, pnpm, install, `pnpm audit --audit-level=critical`, `nx format:check --all`, `nx run web:lint`, then validators: security, content, docs-integrity, governance, i18n, pgf, intelligence, authority-signals, experience-intelligence, frameworks, aec, orchestration, content-os, home, sitemap, image-sitemap, media-manifest, media-derivatives, media-authority, media-governance, visual-contract, **lighthouse-config-validate**, seo, tokens, token-drift, authority-program, authority-constitution, agent-overlay-validate, then `nx run docs:arch:check`, then `nx run web:test` | Any step exits non-zero. Note: verify-fast omits briefing-contracts-validate and telemetry-scoring-validate; local `web:verify` includes them. |
| **build**       | Install, `nx run web:build`, `git checkout -- apps/web/next-env.d.ts`, then assert `git status` is clean                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | Build fails or uncommitted changes.                                                                                                            |
| **a11y**        | Install, Playwright chromium, `nx run web:a11y` (RATE_LIMIT_MODE=off), then `nx run web:rate-limit-verify` (SKIP_RATE_LIMIT_BUILD=1); upload artifact `tmp/reports/a11y.json`                                                                                                                                                                                                                                                                                                                                                                                                                                    | A11y violations, rate-limit verification failure, or script failure. Depends on **build** (needs build output for serve).                      |
| **visual**      | Install, Playwright chromium, `nx run web-e2e:visual`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | Visual regression or presentation-integrity specs fail. Depends on **build**.                                                                  |
| **lighthouse**  | Install, `nx run web:build`, then `lhci autorun` (lighthouserc.cjs)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Performance/accessibility assertions or budget fail.                                                                                           |

Local full parity with the chain is `nx run web:verify`.

## Environment

- **Node:** ≥20.19.0 (`package.json` engines). CI uses 20.19.0.
- **Install:** `pnpm install --frozen-lockfile` for CI parity. `pnpm run ci:verify` does this before verify.
- **Env for build/validators:** `NEXT_PUBLIC_SITE_URL`, `NEXT_PUBLIC_IDENTITY_SAME_AS` must be set for production build and SEO/identity checks. CI sets them to example values. `RELEASE_READY=0` (default): missing optional artifacts/checksums warn only; `RELEASE_READY=1` enforces them. See [docs/quality-gates.md](docs/quality-gates.md).

## Adding or changing steps

- Add a validator: add a target in `apps/web/project.json` that runs the new script, then append that target to `targets.verify.options.commands` in the same doctrinal order (content → docs-integrity → governance → i18n → PGF → intelligence → … → authority-constitution → agent-overlay-validate → telemetry-scoring → test → build → restore → a11y). If it must block merge, add it to the CI job **verify-fast** in `.github/workflows/ci.yml`.
- Do not reorder or skip steps without updating `web:verify`, the CI workflow, this file, and [docs/quality-gates.md](docs/quality-gates.md).

## Reference

- Validator-to-script mapping: [docs/audit/verify-targets-and-validators.md](docs/audit/verify-targets-and-validators.md)
- Per-gate behavior and run instructions: [docs/quality-gates.md](docs/quality-gates.md)
